

WITH ATTENDANCE1 AS 
(SELECT SCH.NAME
,S.STUDENT_NUMBER
, INITCAP(S.LASTFIRST)
, COUNT(ATT_CODE) AS PCOUNT
FROM ATTENDANCE A 
JOIN CALENDAR_DAY CD ON CD.ID = A.CALENDAR_DAYID  
JOIN ATTENDANCE_CODE AC ON AC.ID = A.ATTENDANCE_CODEID 
JOIN CYCLE_DAY CYD ON CYD.ID =CD.CYCLE_DAY_ID 
JOIN SCHOOLS SCH ON SCH.SCHOOL_NUMBER = CD.SCHOOLID 
JOIN STUDENTS S ON S.ID = A.STUDENTID 
WHERE AC.YEARID = 32
AND DATE_VALUE BETWEEN  SYSDATE - 45 AND SYSDATE
AND (AC.ATT_CODE = 'P' OR AC.ATT_CODE = 'VN' OR AC.ATT_CODE = 'L' OR AC.ATT_CODE = 'T') 
AND S.ENROLL_STATUS = 0 
AND A.SCHOOLID = S.SCHOOLID 
GROUP BY SCH.NAME
, S.STUDENT_NUMBER
, INITCAP(S.LASTFIRST) 
ORDER BY SCH.NAME
, COUNT(ATT_CODE)
, INITCAP(S.LASTFIRST)
)
, HR999 AS 
(SELECT DISTINCT 
 SCH.NAME 
, S.STATE_STUDENTNUMBER
, S.STUDENT_NUMBER
, S.LASTFIRST 
, S.GRADE_LEVEL 
, INITCAP(T.LASTFIRST) AS TEACHER
FROM STUDENTS S
LEFT OUTER JOIN SCHOOLS SCH ON SCH.SCHOOL_NUMBER = S.SCHOOLID
LEFT OUTER JOIN CC ON S.ID = CC.STUDENTID 
LEFT OUTER JOIN COURSES C ON C.COURSE_NUMBER = CC.COURSE_NUMBER 
LEFT OUTER JOIN TERMS ON TERMS.ID = CC.TERMID 
LEFT OUTER JOIN TEACHERS T ON T.ID = CC.TEACHERID  
WHERE (CC.TERMID IN (3201, 3200, 3202,3203) OR CC.TERMID IS NULL) 
AND C.COURSE_NUMBER IN ('HR999', 'HR9999')
AND S.ENROLL_STATUS = 0
)
,

COURSECOUNT AS (SELECT 
CC.SCHOOLID
,CC.STUDENTID
, COUNT(*) NO_CLASSES
FROM CC
WHERE TERMID > '3199'
GROUP BY 
CC.SCHOOLID
,CC.STUDENTID
)
SELECT S.DCID
, SCH.NAME
, S.STUDENT_NUMBER
, S.STATE_STUDENTNUMBER
, INITCAP(S.LASTFIRST)
, S.GRADE_LEVEL
, TO_CHAR(S.ENTRYDATE, 'MM/DD/YYYY') AS ENTRYDATE
, DECODE(A.PCOUNT, NULL, 'NO Ps, REVIEW', A.PCOUNT)  AS PCOUNT
, DECODE(HR999.TEACHER, NULL, 'No', 'Yes') AS HR999
, DECODE(COURSECOUNT.NO_CLASSES, NULL, '0', COURSECOUNT.NO_CLASSES) AS NOCLASSES
FROM STUDENTS S 
LEFT OUTER JOIN ATTENDANCE1 A ON A.STUDENT_NUMBER = S.STUDENT_NUMBER 
JOIN SCHOOLS SCH ON SCH.SCHOOL_NUMBER = S.SCHOOLID
LEFT OUTER JOIN HR999 ON HR999.STUDENT_NUMBER = S.STUDENT_NUMBER
LEFT OUTER JOIN COURSECOUNT ON COURSECOUNT.STUDENTID = S.ID AND  COURSECOUNT.SCHOOLID = S.SCHOOLID
LEFT OUTER JOIN S_IN_STU_X ON S_IN_STU_X.STUDENTSDCID = S.DCID
WHERE S.ENROLL_STATUS = 0 
AND S.SCHOOLID NOT IN (145, 131)
AND (S_IN_STU_X.PRIMARYSCHOOLENROLLMENT IS NULL OR S_IN_STU_X.PRIMARYSCHOOLENROLLMENT <> 'N')
~[IF.IS.A.SCHOOL] AND S.SCHOOLID = ~(CURSCHOOLID) [/IF] 
ORDER BY A.PCOUNT DESC, SCH.NAME, S.LASTFIRST
